import { useEffect, useMemo } from 'react';
import Link from 'next/link';
import { useRouter } from 'next/router';
import { useAppDispatch, useAppSelector } from '../store/hooks';
import { signout } from '../store/slices/authSlice';
import { fetchActivities } from '../store/slices/activitiesSlice';
import ActivityForm from '../components/ActivityForm';
import ActivityList from '../components/ActivityList';

export default function Dashboard() {
  const router = useRouter();
  const dispatch = useAppDispatch();
  const { user, isAuthenticated } = useAppSelector((state) => state.auth);
  const { items: activities } = useAppSelector((state) => state.activities);

  useEffect(() => {
    if (!isAuthenticated) {
      router.push('/login');
      return;
    }

    if (user) {
      dispatch(fetchActivities(user.id));
    }
  }, [isAuthenticated, user, dispatch, router]);

  const handleLogout = async () => {
    await dispatch(signout());
    router.push('/');
  };

  const stats = useMemo(() => {
    const now = new Date();
    const weekAgo = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);
    
    const weekActivities = activities.filter(act => {
      const actDate = new Date(act.date);
      return actDate >= weekAgo && actDate <= now;
    });

    const totalDistance = activities.reduce((sum, act) => sum + (act.distance || 0), 0);
    const totalTime = activities.reduce((sum, act) => sum + (act.duration || 0), 0);

    return {
      weekCount: weekActivities.length,
      totalDistance: totalDistance.toFixed(1),
      totalTime: Math.round(totalTime)
    };
  }, [activities]);

  if (!isAuthenticated || !user) {
    return <div className="loading-screen">Loading...</div>;
  }

  return (
    <div className="dashboard-layout">
      <aside className="sidebar">
        <div className="sidebar-header">
          <div className="logo-container">
            <div className="logo-icon">
              <svg width="23" height="18" viewBox="0 0 23 18" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path d="M3.375 2.25C3.375 1.62773 3.87773 1.125 4.5 1.125H5.625C6.24727 1.125 6.75 1.62773 6.75 2.25V7.875V10.125V15.75C6.75 16.3723 6.24727 16.875 5.625 16.875H4.5C3.87773 16.875 3.375 16.3723 3.375 15.75V13.5H2.25C1.62773 13.5 1.125 12.9973 1.125 12.375V10.125C0.502734 10.125 0 9.62227 0 9C0 8.37773 0.502734 7.875 1.125 7.875V5.625C1.125 5.00273 1.62773 4.5 2.25 4.5H3.375V2.25ZM19.125 2.25V4.5H20.25C20.8723 4.5 21.375 5.00273 21.375 5.625V7.875C21.9973 7.875 22.5 8.37773 22.5 9C22.5 9.62227 21.9973 10.125 21.375 10.125V12.375C21.375 12.9973 20.8723 13.5 20.25 13.5H19.125V15.75C19.125 16.3723 18.6223 16.875 18 16.875H16.875C16.2527 16.875 15.75 16.3723 15.75 15.75V10.125V7.875V2.25C15.75 1.62773 16.2527 1.125 16.875 1.125H18C18.6223 1.125 19.125 1.62773 19.125 2.25ZM14.625 7.875V10.125H7.875V7.875H14.625Z" fill="white"/>
              </svg>
            </div>
            <span className="logo-text">FitTrack</span>
          </div>
        </div>

        <nav className="sidebar-nav">
          <ul className="nav-list">
            <li className="nav-item">
              <Link href="/dashboard" className="nav-link active">
                <svg width="18" height="16" viewBox="0 0 18 16" fill="none" xmlns="http://www.w3.org/2000/svg">
                  <path d="M17.9937 7.98438C17.9937 8.54688 17.525 8.9875 16.9937 8.9875H15.9937L16.0156 13.9937C16.0156 14.0781 16.0094 14.1625 16 14.2469V14.75C16 15.4406 15.4406 16 14.75 16H14.25C14.2156 16 14.1813 16 14.1469 15.9969C14.1031 16 14.0594 16 14.0156 16H13H12.25C11.5594 16 11 15.4406 11 14.75V14V12C11 11.4469 10.5531 11 10 11H8C7.44688 11 7 11.4469 7 12V14V14.75C7 15.4406 6.44063 16 5.75 16H5H4.00313C3.95625 16 3.90937 15.9969 3.8625 15.9937C3.825 15.9969 3.7875 16 3.75 16H3.25C2.55938 16 2 15.4406 2 14.75V11.25C2 11.2219 2 11.1906 2.00312 11.1625V8.9875H1C0.4375 8.9875 0 8.55 0 7.98438C0 7.70312 0.09375 7.45312 0.3125 7.23438L8.325 0.25C8.54375 0.03125 8.79375 0 9.0125 0C9.23125 0 9.48125 0.0625 9.66875 0.21875L17.65 7.23438C17.9 7.45312 18.025 7.70312 17.9937 7.98438Z" fill="white"/>
                </svg>
                <span>Home</span>
              </Link>
            </li>
            <li className="nav-item">
              <Link href="/dashboard" className="nav-link">
                <svg width="16" height="16" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg">
                  <path d="M8 16C10.1217 16 12.1566 15.1571 13.6569 13.6569C15.1571 12.1566 16 10.1217 16 8C16 5.87827 15.1571 3.84344 13.6569 2.34315C12.1566 0.842855 10.1217 0 8 0C5.87827 0 3.84344 0.842855 2.34315 2.34315C0.842855 3.84344 0 5.87827 0 8C0 10.1217 0.842855 12.1566 2.34315 13.6569C3.84344 15.1571 5.87827 16 8 16ZM7.25 10.75V8.75H5.25C4.83437 8.75 4.5 8.41562 4.5 8C4.5 7.58437 4.83437 7.25 5.25 7.25H7.25V5.25C7.25 4.83437 7.58437 4.5 8 4.5C8.41562 4.5 8.75 4.83437 8.75 5.25V7.25H10.75C11.1656 7.25 11.5 7.58437 11.5 8C11.5 8.41562 11.1656 8.75 10.75 8.75H8.75V10.75C8.75 11.1656 8.41562 11.5 8 11.5C7.58437 11.5 7.25 11.1656 7.25 10.75Z" fill="#4B5563"/>
                </svg>
                <span>Add Activities</span>
              </Link>
            </li>
            <li className="nav-item">
              <Link href="/dashboard" className="nav-link">
                <svg width="16" height="16" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg">
                  <path d="M15.4969 5.20625C15.5969 5.47813 15.5125 5.78125 15.2969 5.975L13.9438 7.20625C13.9781 7.46563 13.9969 7.73125 13.9969 8C13.9969 8.26875 13.9781 8.53438 13.9438 8.79375L15.2969 10.025C15.5125 10.2188 15.5969 10.5219 15.4969 10.7937C15.3594 11.1656 15.1938 11.5219 15.0031 11.8656L14.8562 12.1187C14.65 12.4625 14.4187 12.7875 14.1656 13.0938C13.9812 13.3188 13.675 13.3937 13.4 13.3062L11.6594 12.7531C11.2406 13.075 10.7781 13.3438 10.2844 13.5469L9.89375 15.3313C9.83125 15.6156 9.6125 15.8406 9.325 15.8875C8.89375 15.9594 8.45 15.9969 7.99687 15.9969C7.54375 15.9969 7.1 15.9594 6.66875 15.8875C6.38125 15.8406 6.1625 15.6156 6.1 15.3313L5.70937 13.5469C5.21562 13.3438 4.75312 13.075 4.33437 12.7531L2.59687 13.3094C2.32187 13.3969 2.01562 13.3188 1.83125 13.0969C1.57812 12.7906 1.34687 12.4656 1.14062 12.1219L0.99375 11.8687C0.803125 11.525 0.6375 11.1687 0.5 10.7969C0.4 10.525 0.484375 10.2219 0.7 10.0281L2.05312 8.79688C2.01875 8.53438 2 8.26875 2 8C2 7.73125 2.01875 7.46563 2.05312 7.20625L0.7 5.975C0.484375 5.78125 0.4 5.47813 0.5 5.20625C0.6375 4.83438 0.803125 4.47813 0.99375 4.13438L1.14062 3.88125C1.34687 3.5375 1.57812 3.2125 1.83125 2.90625C2.01562 2.68125 2.32187 2.60625 2.59687 2.69375L4.3375 3.24688C4.75625 2.925 5.21875 2.65625 5.7125 2.45312L6.10312 0.66875C6.16562 0.384375 6.38437 0.159375 6.67187 0.1125C7.10312 0.0375 7.54687 0 8 0C8.45312 0 8.89688 0.0375 9.32812 0.109375C9.61563 0.15625 9.83438 0.38125 9.89688 0.665625L10.2875 2.45C10.7812 2.65313 11.2438 2.92188 11.6625 3.24375L13.4031 2.69062C13.6781 2.60312 13.9844 2.68125 14.1687 2.90313C14.4219 3.20938 14.6531 3.53437 14.8594 3.87812L15.0063 4.13125C15.1969 4.475 15.3625 4.83125 15.5 5.20312L15.4969 5.20625ZM8 10.5C8.66304 10.5 9.29893 10.2366 9.76777 9.76777C10.2366 9.29893 10.5 8.66304 10.5 8C10.5 7.33696 10.2366 6.70107 9.76777 6.23223C9.29893 5.76339 8.66304 5.5 8 5.5C7.33696 5.5 6.70107 5.76339 6.23223 6.23223C5.76339 6.70107 5.5 7.33696 5.5 8C5.5 8.66304 5.76339 9.29893 6.23223 9.76777C6.70107 10.2366 7.33696 10.5 8 10.5Z" fill="#4B5563"/>
                </svg>
                <span>Manage Activities</span>
              </Link>
            </li>
          </ul>
        </nav>
      </aside>

      <main className="main-content">
        <header className="top-header">
          <h1 className="page-title">Add Activities</h1>
          <div className="header-actions">
            <span className="user-email">{user.email}</span>
            <button className="logout-button" onClick={handleLogout}>
              <svg width="16" height="16" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path d="M11.8094 3.30938L15.6469 7.14687C15.8719 7.37187 16 7.68125 16 8C16 8.31875 15.8719 8.62812 15.6469 8.85312L11.8094 12.6906C11.6094 12.8906 11.3406 13 11.0594 13C10.475 13 10 12.525 10 11.9406V10H6C5.44688 10 5 9.55313 5 9V7C5 6.44688 5.44688 6 6 6H10V4.05937C10 3.475 10.475 3 11.0594 3C11.3406 3 11.6094 3.1125 11.8094 3.30938ZM5 3H3C2.44688 3 2 3.44688 2 4V12C2 12.5531 2.44688 13 3 13H5C5.55312 13 6 13.4469 6 14C6 14.5531 5.55312 15 5 15H3C1.34375 15 0 13.6562 0 12V4C0 2.34375 1.34375 1 3 1H5C5.55312 1 6 1.44687 6 2C6 2.55313 5.55312 3 5 3Z" fill="white"/>
              </svg>
              <span>Logout</span>
            </button>
          </div>
        </header>

        <div className="content-wrapper">
          <div className="main-grid">
            <div className="content-card">
              <div className="card-header">
                <div className="card-icon green">
                  <svg width="14" height="16" viewBox="0 0 14 16" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M8 2.5C8 1.94687 7.55312 1.5 7 1.5C6.44688 1.5 6 1.94687 6 2.5V7H1.5C0.946875 7 0.5 7.44688 0.5 8C0.5 8.55312 0.946875 9 1.5 9H6V13.5C6 14.0531 6.44688 14.5 7 14.5C7.55312 14.5 8 14.0531 8 13.5V9H12.5C13.0531 9 13.5 8.55312 13.5 8C13.5 7.44688 13.0531 7 12.5 7H8V2.5Z" fill="white"/>
                  </svg>
                </div>
                <h2 className="card-title">Add Activity</h2>
              </div>
              <ActivityForm />
            </div>

            <div className="content-card">
              <div className="card-header">
                <div className="card-icon green">
                  <svg width="16" height="16" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M1.25 1.5C0.834375 1.5 0.5 1.83437 0.5 2.25V3.75C0.5 4.16563 0.834375 4.5 1.25 4.5H2.75C3.16563 4.5 3.5 4.16563 3.5 3.75V2.25C3.5 1.83437 3.16563 1.5 2.75 1.5H1.25ZM6 2C5.44688 2 5 2.44687 5 3C5 3.55312 5.44688 4 6 4H15C15.5531 4 16 3.55312 16 3C16 2.44687 15.5531 2 15 2H6ZM6 7C5.44688 7 5 7.44688 5 8C5 8.55312 5.44688 9 6 9H15C15.5531 9 16 8.55312 16 8C16 7.44688 15.5531 7 15 7H6ZM6 12C5.44688 12 5 12.4469 5 13C5 13.5531 5.44688 14 6 14H15C15.5531 14 16 13.5531 16 13C16 12.4469 15.5531 12 15 12H6ZM0.5 7.25V8.75C0.5 9.16563 0.834375 9.5 1.25 9.5H2.75C3.16563 9.5 3.5 9.16563 3.5 8.75V7.25C3.5 6.83437 3.16563 6.5 2.75 6.5H1.25C0.834375 6.5 0.5 6.83437 0.5 7.25ZM1.25 11.5C0.834375 11.5 0.5 11.8344 0.5 12.25V13.75C0.5 14.1656 0.834375 14.5 1.25 14.5H2.75C3.16563 14.5 3.5 14.1656 3.5 13.75V12.25C3.5 11.8344 3.16563 11.5 2.75 11.5H1.25Z" fill="white"/>
                  </svg>
                </div>
                <h2 className="card-title">Activities List</h2>
              </div>
              <ActivityList />
            </div>
          </div>

          <div className="stats-grid">
            <div className="stat-card">
              <div className="stat-icon blue">
                <svg width="18" height="20" viewBox="0 0 18 20" fill="none" xmlns="http://www.w3.org/2000/svg">
                  <path d="M5 0C5.69141 0 6.25 0.558594 6.25 1.25V2.5H11.25V1.25C11.25 0.558594 11.8086 0 12.5 0C13.1914 0 13.75 0.558594 13.75 1.25V2.5H15.625C16.6602 2.5 17.5 3.33984 17.5 4.375V6.25H0V4.375C0 3.33984 0.839844 2.5 1.875 2.5H3.75V1.25C3.75 0.558594 4.30859 0 5 0ZM0 7.5H17.5V18.125C17.5 19.1602 16.6602 20 15.625 20H1.875C0.839844 20 0 19.1602 0 18.125V7.5ZM3.125 10C2.78125 10 2.5 10.2812 2.5 10.625V13.125C2.5 13.4688 2.78125 13.75 3.125 13.75H14.375C14.7188 13.75 15 13.4688 15 13.125V10.625C15 10.2812 14.7188 10 14.375 10H3.125Z" fill="#2563EB"/>
                </svg>
              </div>
              <div className="stat-info">
                <div className="stat-label">This Week</div>
                <div className="stat-value">{stats.weekCount} activities</div>
              </div>
            </div>

            <div className="stat-card">
              <div className="stat-icon green">
                <svg width="20" height="20" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg">
                  <path d="M20 3.75C20 5.71094 17.6914 8.63672 16.6953 9.80469C16.5469 9.97656 16.3281 10.043 16.1289 10H12.5C11.8086 10 11.25 10.5586 11.25 11.25C11.25 11.9414 11.8086 12.5 12.5 12.5H16.25C18.3203 12.5 20 14.1797 20 16.25C20 18.3203 18.3203 20 16.25 20H5.45312C5.79297 19.6133 6.20703 19.1172 6.625 18.5625C6.87109 18.2344 7.125 17.875 7.36719 17.5H16.25C16.9414 17.5 17.5 16.9414 17.5 16.25C17.5 15.5586 16.9414 15 16.25 15H12.5C10.4297 15 8.75 13.3203 8.75 11.25C8.75 9.17969 10.4297 7.5 12.5 7.5H14.0547C13.2344 6.26953 12.5 4.85547 12.5 3.75C12.5 1.67969 14.1797 0 16.25 0C18.3203 0 20 1.67969 20 3.75ZM4.57422 19.1055C4.42578 19.2734 4.29297 19.4219 4.17969 19.5469L4.10938 19.625L4.10156 19.6172C3.86719 19.7969 3.53125 19.7734 3.32031 19.5469C2.33594 18.4766 0 15.7227 0 13.75C0 11.6797 1.67969 10 3.75 10C5.82031 10 7.5 11.6797 7.5 13.75C7.5 14.9219 6.67578 16.3672 5.80078 17.5742C5.38281 18.1484 4.95312 18.668 4.59766 19.0781L4.57422 19.1055ZM5 13.75C5 13.4185 4.8683 13.1005 4.63388 12.8661C4.39946 12.6317 4.08152 12.5 3.75 12.5C3.41848 12.5 3.10054 12.6317 2.86612 12.8661C2.6317 13.1005 2.5 13.4185 2.5 13.75C2.5 14.0815 2.6317 14.3995 2.86612 14.6339C3.10054 14.8683 3.41848 15 3.75 15C4.08152 15 4.39946 14.8683 4.63388 14.6339C4.8683 14.3995 5 14.0815 5 13.75ZM16.25 5C16.5815 5 16.8995 4.8683 17.1339 4.63388C17.3683 4.39946 17.5 4.08152 17.5 3.75C17.5 3.41848 17.3683 3.10054 17.1339 2.86612C16.8995 2.6317 16.5815 2.5 16.25 2.5C15.9185 2.5 15.6005 2.6317 15.3661 2.86612C15.1317 3.10054 15 3.41848 15 3.75C15 4.08152 15.1317 4.39946 15.3661 4.63388C15.6005 4.8683 15.9185 5 16.25 5Z" fill="#16A34A"/>
                </svg>
              </div>
              <div className="stat-info">
                <div className="stat-label">Total Distance</div>
                <div className="stat-value">{stats.totalDistance} km</div>
              </div>
            </div>

            <div className="stat-card">
              <div className="stat-icon purple">
                <svg width="20" height="20" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg">
                  <path d="M10 0C12.6522 0 15.1957 1.05357 17.0711 2.92893C18.9464 4.8043 20 7.34784 20 10C20 12.6522 18.9464 15.1957 17.0711 17.0711C15.1957 18.9464 12.6522 20 10 20C7.34784 20 4.8043 18.9464 2.92893 17.0711C1.05357 15.1957 0 12.6522 0 10C0 7.34784 1.05357 4.8043 2.92893 2.92893C4.8043 1.05357 7.34784 0 10 0ZM9.0625 4.6875V10C9.0625 10.3125 9.21875 10.6055 9.48047 10.7812L13.2305 13.2812C13.6602 13.5703 14.2422 13.4531 14.5312 13.0195C14.8203 12.5859 14.7031 12.0078 14.2695 11.7188L10.9375 9.5V4.6875C10.9375 4.16797 10.5195 3.75 10 3.75C9.48047 3.75 9.0625 4.16797 9.0625 4.6875Z" fill="#9333EA"/>
                </svg>
              </div>
              <div className="stat-info">
                <div className="stat-label">Total Time</div>
                <div className="stat-value">{stats.totalTime} min</div>
              </div>
            </div>
          </div>
        </div>
      </main>
    </div>
  );
}
